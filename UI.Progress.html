<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css">
		<style>
			body { padding: 20px; }
			progress { width: 100%; }
			.error { color: #d32f2f; }
		</style>
	</head>
	<body>
		<main>
			<h3 id="title"><?= _('Initialisation...') ?></h3>
			<progress id="progress-bar" value="0" max="100"></progress>
			<p id="status-message"><?= _('Préparation des données...') ?></p>
			<button id="close-btn" onclick="google.script.host.close()" style="display:none;"><?= _('Fermer') ?></button>
		</main>

		<script>
			let targetProgress = 0;
			let displayProgress = 0;
			let animationFrameId;

			window.onload = function()
			{
				startProcess();
				pollStatus();
				animateProgress();
			};

			function startProcess()
			{
				google.script.run
					.withSuccessHandler(onComplete)
					.withFailureHandler(onError)
					.startFIPGeneration();
			}

			function pollStatus()
			{
				const interval = setInterval(function()
				{
					google.script.run
						.withSuccessHandler(function(statusJson)
						{
							if (!statusJson)
							{
								return;
							}

							const status = JSON.parse(statusJson);
							targetProgress = Number(status.progress);
							updateMessage(status.message);

							if (targetProgress >= 100)
							{
								clearInterval(interval);
							}
						})
						.withFailureHandler(function(e)
						{
							console.error('Polling failed', e);
						})
						.getFIPGenerationStatus();
				}, 2000);
			}

			function animateProgress()
			{
				// Smooth interpolation: move displayProgress 10% of the way to targetProgress per frame
				if (Math.abs(displayProgress - targetProgress) > 0.01)
				{
					displayProgress += (targetProgress - displayProgress) * 0.1;
				}
				else
				{
					displayProgress = targetProgress;
				}

				updateVisuals(displayProgress);
				animationFrameId = requestAnimationFrame(animateProgress);
			}

			function updateMessage(message)
			{
				const statusMsg = document.getElementById('status-message');
				if (statusMsg)
				{
					statusMsg.textContent = message;
				}
			}

			function updateVisuals(progress)
			{
				const progressBar = document.getElementById('progress-bar');
				const title = document.getElementById('title');

				if (progressBar)
				{
					progressBar.value = progress;
				}
				if (title)
				{
					title.textContent = progress.toFixed(1) + '%';
				}
			}

			function onComplete()
			{
				targetProgress = 100; // Ensure we finish filling
				updateMessage("<?= _('Génération terminée avec succès.') ?>");
				document.getElementById('close-btn').style.display = 'block';
			}

			function onError(e)
			{
				targetProgress = 100;
				updateMessage("<?= _('Erreur critique : ') ?>" + e.message);
				document.getElementById('status-message').className = 'error';
				cancelAnimationFrame(animationFrameId);
				updateVisuals(100);
			}
		</script>
	</body>
</html>
<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css">
	</head>
	<body>
		<main class="container">
			<form onsubmit="event.preventDefault(); upload();">
				<label for="file"><?= _('Fichier AssoConnect XLSX') ?></label>
				<input type="file" id="file" name="file" accept=".xlsx, .xls" required>
				<button type="submit"><?= _('Mettre à jour') ?></button>
			</form>
			<div id="status"></div>
		</main>
		<script>
			function upload()
			{
				const fileInput = document.getElementById('file');
				const file = fileInput.files[0];

				if (!file)
				{
					return;
				}

				document.getElementById('status').innerHTML = '<progress indeterminate></progress>';
				resize();

				const reader = new FileReader;
				reader.onload = function (e)
				{
					const dataUrl = e.target.result;
					const data = dataUrl.split(',')[1];
					const fileData = {
						name: file.name,
						mimeType: file.type,
						data: data
					};

					google.script.run
						.withSuccessHandler(onSuccess)
						.withFailureHandler(onFailure)
						.updateAssoConnectFromFile(fileData);
				};
				reader.readAsDataURL(file);
			}

			function onSuccess()
			{
				document.getElementById('status').innerHTML = `<p>${<?= JSON.stringify(_('Importation réussie')) ?>}</p>`;
				resize();
				setTimeout(() => google.script.host.close(), 2000);
			}

			function onFailure(error)
			{
				document.getElementById('status').innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
				resize();
			}

			function resize()
			{
				// Add a small buffer to avoid scrollbars
				const height = document.body.scrollHeight + 10;
				google.script.host.setHeight(height);
			}

			// Initial resize on load
			window.onload = resize;
